## **多VPC互通**

同一地域内三个以下VPC需互通时，尽量选用“VPC对等连接”产品，时延小、配置简单；但当需要互通的VPC数量较多时，可基于边界网关创建与不同VPC连接的边界网关接口，简化配置部署。

``多VPC互联通前，应规划好所有需互通的VPC内网段，尽量保证VPC内的网段不会重叠。如果网段重叠实在不可避免，需要合理配置VPC与边界网关的路由传播范围，保证同一路由表内网段不重叠。``



### **如果使用边界网关连通京东智联云上的多个VPC，那么您需要完成以下步骤：**

第一步：创建边界网关

第二步：创建边界网关接口

第三步：配置VPC内的路由表

第四步：配置边界网关上的路由表



### **详细步骤如下：**


#### **第一步：创建边界网关**

1.登录京东智联云控制台。

2.点击左侧导航栏，选择“专线服务 -> 边界网关”。

3.创建边界网关，新建的边界网关不会与任何VPC或者通道连接、需要配置创建边界网关接口或者专线通道等建立连接通道。



**第二步：创建边界网关的VPC接口**

1.登录京东智联云控制台。

2.点击左侧导航栏，选择“专线服务 -> 边界网关 -> VPC接口-> 创建”。

3.配置VPC接口，以便边界网关与选定的VPC建立连接、进行互通，详见控制台页面。

目前VPC接口仅支持同地域的VPC与边界网关互联。同一个VPC和同一个边界网关只能创建一个VPC接口。同一个VPC可与多个不同边界网关创建不同的VPC接口，另外一个边界网关支持与多个不同VPC创建不同的VPC接口

主要配置项如下：

- - 接口名称：边界网关与VPC连接的接口名称；

  - 边界网关：选择需要互联的边界网关。边界网关对内与VPC进行通信，同时可作为京东智联云侧和客户IDC侧运行BGP的终结点；
  
  - VPC：选择需要互联的VPC；
  
  - 传播的VPC网段：
  
    ``VPC全部网段``，边界网关的路由全自动引入方式，表示系统将自动在边界网关的路由表内添加访问VPC全网段的路由表项。全网段包括VPC当前全部子网的网段，并且将根据VPC子网后续的变化自动更新边界网关的路由表项——如后续新增子网时、系统将自动将到达新子网的路由添加到边界网关路由表，删除子网时、自动同步删除边界网关对应的路由表项
    
    ``指定子网网段``，边界网关的路由半自动引入方式，表示系统将自动在边界网关的路由表内添加访问VPC内已指定网段的路由。这种方式下，边界网关的路由将不会自动适配VPC内指定子网以外的调整，如新增或者删除指定范围外的子网都不会引起边界网关的路由变化；但若是指定范围内的子网变化，如删除范围内子网、需要先删除VPC接口的传播子网段。
    
    ``不传播网段``，边界网关的路由全手动配置方式，表示系统不会自动在边界网关路由表内添加任何访问VPC的路由，需要用户在BGW路由表内手动配置静态路由。

4.单击“确定”，在VPC接口列表中，该通道的状态为配置中。

5.边界网关接口完成配置后，通道状态变为可用，此时即可使用该连接进行数据传输。

``特殊说明：当边界网关VPC内子网网段与其他通道连接网段存在重叠时，创建VPC接口时可选“指定子网网段”、并选相互不重叠的子网网段，避免重叠VPC子网网段传播到边界网关路由表，以满足某些VPC地址存在重叠的应用场景需求``


#### **第三步：配置VPC内的路由表**

1.登录京东智联云控制台。

2.点击左侧导航栏，选择“私有网络”，进入需要与同地域其他VPC进行通信的京东智联云VPC内子网所关联的路由表。

3.配置路由表，有两种方式：静态路由方式，路由自动传播方式。

  静态路由方式：
  
  如果计划完全自定义路由，就采用静态路由配置方式。在路由表的“路由策略”页面点击编辑，新增路由规则，其中目的端为您期望被访问的VPC网段，下一跳类型选择边界网关，下一跳选择所需互联边界网关的VPC接口。

  路由自动传播方式：
  
  如果想简化网络配置过程，利用京东智联云平台提供的从边界网关自动传播路由到VPC路由表的能力，就采用路由自动传播方式。在路由表的“路由传播”页面点击添加、进行路由传播信息的填写。一个VPC可以同时与多个边界网关建立路由传播关系。
  
- - 边界网关：选择向VPC传播路由的源边界网关

  - 路由传播范围：指从边界网关传播到VPC的路由前缀CIDR地址范围，支持输入多个CIDR范围，多个之间以英文逗号分隔。配置传播路由后，将自动将所选边界网关中该网段及其子网段的路由传播到此路由表。支持配置传播0.0.0.0/0路由，此时将传播所选边界网关中的全部路由。

      配置生效后，系统将从边界网关有效路由表中选择路由前缀在传播范围内的路由规则（包括静态和动态路由），自动添加VPC路由表内，下一跳类型为边界网关、下一跳指向“路由传播”配置中指定的边界网关名称、路由类型为传播。传播类型路由不可编辑。

#### **第四步：配置边界网关上的路由表**

1.登录京东智联云控制台。

2.点击左侧导航栏，选择“专线服务 -> 边界网关”，进入用于承载专线连接网络互通的边界网关的详情页面。

3.配置路由表，设定通往每个VPC的路由表项，有两种方式：静态路由方式，路由自动传播方式。

静态路由方式：

当创建边界网关与VPC互联的VPC接口时，如果传播VPC网段选择“不传播网段”时，需要手动配置到达多个VPC的路由，即逐项配置通往所有需要互通的VPC侧的静态路由。配置通往VPC侧的静态路由，选择“路由表->静态路由表”，点击“编辑”，路由规则目的端为VPC内的网段，下一跳类型选择VPC接口，下一跳选择要进行通信的具体VPC接口信息。

路由自动传播方式：

当创建边界网关与VPC互联的VPC接口时，如果传播VPC网段选择“VPC全部网段”或者“指定子网网段”时，即为路由自动传播方式。边界网关路由表会依据配置的子网范围，在动态路由表自动添加或者删除到达相关子网的路由表项，目的网段为VPC子网网段、下一跳类型选择VPC接口、下一跳为连接指定VPC和边界网关的VPC接口、路由类型为传播。动态传播路由将与静态路由表的路由统一进行优先级比对，高优先级路由会自动加入有效路由表内。用户可直接在路由表内查看动态传播路由、不需要用户配置，用户也不可以修改、删除动态传播路由。





