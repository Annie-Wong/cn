## 专业术语

| 术语 | 定义 |
|:---:|:---:|
| BGW | Border Gateway，边界网关，外部访问VPC内业务的流量终结点 |
| DLR | 专线路由器(Dedicated Line Router)，专线连接服务需要用到的三层路由设备，用于和客户端之间运行路由协议 |
| VNET | Virtual Network，虚拟网络 |
| Circuit | 线路，客户与京东云间连接的物理链路的逻辑描述 |
| IXP | Internet Exchange Point，互联网交换节点 |
| CXP | Cloud Exchange Point，云交换节点 |
| BGP | Border Gateway Protocal，边界网关协议 |
| Partner | 京东云专线连接服务的合作伙伴，为京东云客户提供专线连接服务 |
| S-tag | 一个vlan tag，用于配置QinQ时在物理端口上唯一标识一个客户的数据流，QinQ的外层tag |
| C-tag | 一个vlan tag，用于配置QinQ时在物理端口上唯一标识客户的一个业务通道的数据流，QinQ的内层tag |

 ## 动态路由设计说明

边界网关作为京东云多个隔离网络(VPC)之间、或者从京东云云端与用户IDC互联的路由网关，提供了静态与BGP动态路由能力，同时为了简化用户业务部署而支持了VPC与边界网关之间路由的双向传播能力、以及边界网关与IDC内网关通过EBGP动态宣告路由能力，以便完整支持从VPC到IDC端到端的路由自动更新。

### 路由传播

路由传播是通过手动配置方式之外获取的路由规则，例如通过标准BGP协议等动态路由方式学习到的路由，或者通过内部工作机制将不同网关实体（如VPC路由表所在的路由网关、边界网关）的路由表项信息进行同步、自动更新到达或者经由彼此转发业务的路由信息。

- VPC路由表和边界网关路由表之间可通过VPC接口实现双向路由动态传播：

边界网关->VPC方向的路由传播：当VPC路由表配置路由传播时，选择路由传播的源边界网关与填写路由传播范围。传播关系创建后，系统将自动把该边界网关有效路由表中、路由前缀在传播范围内的特定路由规则自动添加VPC路由表内，并且下一跳指向与该VPC创建传播关系的边界网关；

VPC->边界网关方向的路由传播：当基于BGW创建VPC接口时，如果传播VPC网段选择“VPC全部网段”或者“指定子网网段”时，即为路由自动传播方式。边界网关路由表会依据配置的子网范围，自动添加或者删除到达相关子网的路由表项，路由前缀为子网网段、下一跳为连接指定VPC和边界网关的VPC接口。

- 边界网关与用户IDC网关通过BGP协议学习到的路由，路由类型在边界网关路由表中也定义为传播路由。包括：
边界网关通过专线通道承载的EBGP从用户IDC网关学习到的路由；
边界网关通过托管通道承载的EBGP从京东云托管区网关学习到的路由；
边界网关通过VPN通道承载的EBGP从用户IDC网关学习到的路由。

- 边界网关向用户IDC网关通过BGP协议宣告边界网关的有效路由。包括：

边界网关通过专线通道承载的EBGP协议向连通的用户IDC网关宣告的有效路由；
边界网关通过托管通道承载的EBGP协议向连通的京东云托管区网关宣告的有效路由；
边界网关通过VPN通道承载的EBGP协议向连通的用户IDC网关宣告的有效路由。

### 路由优先级

#### VPC路由表优先级

VPC路由表支持两种路由类型：传播路由与静态路由。

京东云VPC路由表优先级优先级范围为1~256，数值越小，路由优先级别越高。京东云VPC路由表的静态路由优先级缺省为100，传播路由优先级缺省为120。

#### VPC路由表路由规则匹配顺序：

* Local路由优先；
* 最长前缀（掩码最长前缀）的路由匹配优先；
* 相同前缀相同掩码长度、路由类型不同，则静态路由优于传播路由；
* 相同前缀相同掩码长度、路由类型相同，如同为静态路由、或同为传播路由，则为等价路由(目前等价路由仅支持传播路由、不支持静态路由)。


#### 边界网关路由表优先级

边界网关路由表支持两种路由方式：传播(包括通过BGP学习到的)路由、静态路由。

边界网关的有效路由表依据路由下一跳类型、路由类型、路由Metric等不同层级进行有效路由甄选：
* 第一步，优选下一跳类型优先级最高的路由，若可以确定唯一的路由条目，则返回该路由。目前VPC接口优先级值为100，专线/托管通道优先级值为120，VPN通道优先级值为140，优先级值越小、路由优先级越高。若存在多条优先级相同的路由，则继续下一因素的比较；
* 第二步，优选路由类型优先级最高（路由协议管理距离）的路由，若可以确定唯一的路由条目，则返回该路由。目前静态路由优先级值为100，内部传播（VPC接口传播）路由优先级值为120，EBGP路由优先级值为150，IBGP路由优先级值为200，优先级值越小、路由优先级越高。若存在多条优先级相同的路由，则继续下一因素的比较；
* 第三步，优选Metric优先级最高的路由，若可以确定唯一的路由条目，则返回该路由。如BGP协议的AS_PATH越短，Metric值越小，Metric值越小、路由优先级越高。若存在多条优先级相同的路由，则多条路由均为有效路由，多条路由之间以ECMP的方式转发数据包。


#### 边界网关有效路由匹配顺序

边界网关进行业务数据转发时，将依据边界网关有效路由表内的路由规则进行逐项匹配、然后按照路由规则的下一跳信息将报文转发到相应的接口或者通道。其基本路由匹配和转发规则为：

最长前缀的路由匹配优先；

等价路由则基于每个数据报文头的五元组（TCP/UDP）、三元组（ICMP）或源/目的IP（其他协议类型）进行hash选择不同下一跳路由进行转发。
